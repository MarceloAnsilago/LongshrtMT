{% extends "_base.html" %}

{% block title %}Inicio - Long & Short{% endblock %}

{% block extra_head %}
<style>
  .home-live-field {
    display: inline-block;
  }
  .home-live-flash {
    animation: homeLivePulse 0.6s ease;
  }
  @keyframes homeLivePulse {
    0% {
      opacity: 0.35;
      transform: scale(0.98);
    }
    50% {
      opacity: 1;
      transform: scale(1.02);
    }
    100% {
      opacity: 0.85;
      transform: scale(1);
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="py-3">

  <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h5 fw-semibold mb-1">Operacoes em andamento</h1>
      <p class="text-body-secondary small mb-0">
        Acompanhe as metricas de cada operacao aberta. Clique em um card para revisar ou encerrar.
      </p>
    </div>
    <div class="d-flex flex-column gap-1 align-items-stretch align-items-sm-end">
      <button
        type="button"
        id="home-refresh-live-btn"
        class="btn btn-outline-primary btn-sm"
        data-url="{{ refresh_live_url }}">
        <span class="spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
        <i class="bi bi-arrow-repeat me-1"></i>
        Atualizar cotações
      </button>
      <div id="home-refresh-feedback" class="text-body-secondary small text-end"></div>
      <button
        type="button"
        id="home-refresh-metrics-btn"
        class="btn btn-outline-secondary btn-sm"
        data-url="{{ refresh_metrics_url }}">
        <span class="spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
        <i class="bi bi-graph-up-arrow me-1"></i>
        Atualizar métricas
      </button>
      <div id="home-refresh-metrics-feedback" class="text-body-secondary small text-end"></div>
    </div>
  </div>

  <div id="home-operations-root" data-url="{{ operations_data_url }}">

    <div class="card soft-card shadow-sm rounded-4 mb-3">

      <div class="card-body text-center py-5">

        <div class="spinner-border" role="status" aria-hidden="true"></div>

        <div class="small text-body-secondary mt-3">Carregando operacoes em andamento...</div>

      </div>

    </div>

  </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("home-operations-root");
  const dataUrl = container?.dataset?.url;
  const refreshBtn = document.getElementById("home-refresh-live-btn");
  const feedback = document.getElementById("home-refresh-feedback");
  let refreshUrl = refreshBtn?.dataset?.url;
  const metricsBtn = document.getElementById("home-refresh-metrics-btn");
  const metricsFeedback = document.getElementById("home-refresh-metrics-feedback");
  let metricsUrl = metricsBtn?.dataset?.url;

  const getCookie = (name) => {
    const match = document.cookie.match(new RegExp("(^|;)\\s*" + name + "=([^;]+)"));
    return match ? decodeURIComponent(match[2]) : null;
  };

  const setFeedback = (text = "", isError = false) => {
    if (!feedback) {
      return;
    }
    feedback.textContent = text || "";
    feedback.classList.remove("text-success", "text-danger", "text-body-secondary");
    if (!text) {
      feedback.classList.add("text-body-secondary");
    } else {
      feedback.classList.add(isError ? "text-danger" : "text-success");
    }
  };

  const setMetricsFeedback = (text = "", isError = false) => {
    if (!metricsFeedback) {
      return;
    }
    metricsFeedback.textContent = text || "";
    metricsFeedback.classList.remove("text-success", "text-danger", "text-body-secondary");
    if (!text) {
      metricsFeedback.classList.add("text-body-secondary");
    } else {
      metricsFeedback.classList.add(isError ? "text-danger" : "text-success");
    }
  };

  const renderLoading = () => {
    if (!container) {
      return;
    }
    container.innerHTML = `
      <div class="card soft-card shadow-sm rounded-4 mb-3">
        <div class="card-body text-center py-5">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div class="small text-body-secondary mt-3">Carregando operacoes em andamento...</div>
        </div>
      </div>
    `;
  };

  const renderLoadError = () => {
    if (!container) {
      return;
    }
    container.innerHTML =
      '<div class="alert alert-warning small mb-0">Nao foi possivel carregar as operacoes agora. Tente novamente em alguns segundos.</div>';
  };

  const attachAlertRefresh = () => {
    const alertBtn = document.getElementById("home-refresh-live-alert-btn");
    if (alertBtn && refreshBtn) {
      alertBtn.addEventListener("click", () => refreshBtn.click());
    }
  };

  const loadOperations = () => {
    if (!container || !dataUrl) {
      return;
    }
    renderLoading();
    fetch(dataUrl, {
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Falha ao carregar as operacoes.");
        }
        return response.json();
      })
        .then((payload) => {
          if (payload && payload.html) {
            container.innerHTML = payload.html;
            attachAlertRefresh();
            if (liveUrl) {
              fetchLiveCards();
            }
          } else {
            throw new Error("Resposta invalida.");
          }
      })
      .catch(() => {
        renderLoadError();
      });
  };

  const refreshLiveQuotes = () => {
    if (!refreshBtn || !refreshUrl) {
      return;
    }
    refreshBtn.disabled = true;
    const originalContent = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Atualizando...';
    setFeedback("", false);

    fetch(refreshUrl, {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Falha ao atualizar cotações.");
        }
        return response.json();
      })
      .then((data) => {
        if (!data.ok) {
          throw new Error(data.detail || "Resposta invalida.");
        }
        setFeedback(`Cotações atualizadas: ${data.updated}/${data.total}`, false);
        loadOperations();
      })
      .catch((error) => {
        console.error(error);
        setFeedback(error.message || "Falha ao atualizar cotações.", true);
      })
      .finally(() => {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalContent;
      });
  };

  const refreshMetrics = () => {
    if (!metricsBtn || !metricsUrl) {
      return;
    }
    metricsBtn.disabled = true;
    const originalContent = metricsBtn.innerHTML;
    metricsBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Atualizando...';
    setMetricsFeedback("", false);

    fetch(metricsUrl, {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Falha ao atualizar metricas.");
        }
        return response.json();
      })
      .then((data) => {
        if (!data.ok) {
          throw new Error(data.errors ? data.errors.join("; ") : "Resposta invalida.");
        }
        let message = `Metricas recalculadas para ${data.updated || 0} operacao${(data.updated || 0) === 1 ? "" : "es"}.`;
        if (data.errors && data.errors.length) {
          message += ` Erros: ${data.errors.slice(0, 3).join("; ")}`;
        }
        setMetricsFeedback(message, Boolean(data.errors && data.errors.length));
        loadOperations();
      })
      .catch((error) => {
        console.error(error);
        setMetricsFeedback(error.message || "Falha ao atualizar metricas.", true);
      })
      .finally(() => {
        metricsBtn.disabled = false;
        metricsBtn.innerHTML = originalContent;
      });
  };

  const liveUrl = "{{ home_live_url|default:'' }}";
  const livePollMs = 12000;
  let liveTimer;

  const applyLiveFlash = (el) => {
    if (!el) {
      return;
    }
    el.classList.add("home-live-flash");
    el.addEventListener(
      "animationend",
      () => {
        el.classList.remove("home-live-flash");
      },
      { once: true }
    );
  };

  const updateLiveFieldValue = (opId, field, value) => {
    if (!opId || !field) {
      return;
    }
    const selector = `[data-live-field="${field}"][data-op-id="${opId}"]`;
    const el = document.querySelector(selector);
    if (!el) {
      return;
    }
    const normalized = (value ?? "").trim();
    if (el.textContent.trim() === normalized) {
      return;
    }
    el.textContent = normalized;
    applyLiveFlash(el);
  };

  const removeBadgeClasses = (badge) => {
    if (!badge) {
      return;
    }
    badge.classList.remove(
      "bg-primary-subtle",
      "text-primary",
      "border",
      "border-primary",
      "bg-danger-subtle",
      "text-danger",
      "border-danger",
      "bg-secondary-subtle",
      "text-secondary",
      "border-body-tertiary"
    );
  };

  const updateLiveBadge = (opId, direction) => {
    if (!opId) {
      return;
    }
    const field = "final_direction_label";
    const selector = `[data-live-field="${field}"][data-op-id="${opId}"]`;
    const badge = document.querySelector(selector);
    if (!badge) {
      return;
    }
    const normalized = (direction ?? "").trim();
    badge.textContent = normalized || "--";
    removeBadgeClasses(badge);
    badge.classList.add("text-capitalize", "small", "badge");
    if (normalized === "recebe") {
      badge.classList.add("bg-primary-subtle", "text-primary", "border", "border-primary");
    } else if (normalized === "paga") {
      badge.classList.add("bg-danger-subtle", "text-danger", "border", "border-danger");
    } else {
      badge.classList.add(
        "bg-secondary-subtle",
        "text-secondary",
        "border",
        "border-body-tertiary"
      );
    }
    applyLiveFlash(badge);
  };

  const applyLiveUpdate = (cards) => {
    if (!Array.isArray(cards)) {
      return;
    }
    for (const card of cards) {
      const opId = card.operation_id;
      const prices = card.current_prices || {};
      for (const [field, value] of Object.entries(prices)) {
        updateLiveFieldValue(opId, field, value);
      }
      updateLiveBadge(opId, prices.final_direction_label);
    }
  };

  const fetchLiveCards = () => {
    if (!liveUrl) {
      return Promise.resolve();
    }
    return fetch(liveUrl, {
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Falha ao carregar os dados ao vivo.");
        }
        return response.json();
      })
      .then((payload) => {
        if (payload && payload.ok && Array.isArray(payload.cards)) {
          applyLiveUpdate(payload.cards);
        }
      })
      .catch((error) => {
        console.error("Live quotes error", error);
      });
  };

  const scheduleLiveUpdate = () => {
    if (!liveUrl) {
      return;
    }
    if (liveTimer) {
      clearTimeout(liveTimer);
    }
    liveTimer = setTimeout(() => {
      fetchLiveCards().finally(scheduleLiveUpdate);
    }, livePollMs);
  };

  if (refreshBtn) {
    refreshBtn.addEventListener("click", (ev) => {
      ev.preventDefault();
      refreshLiveQuotes();
    });
  }
  if (metricsBtn) {
    metricsBtn.addEventListener("click", (ev) => {
      ev.preventDefault();
      refreshMetrics();
    });
  }

  if (liveUrl) {
    fetchLiveCards().finally(scheduleLiveUpdate);
  }

  loadOperations();
});
</script>
{% endblock %}
