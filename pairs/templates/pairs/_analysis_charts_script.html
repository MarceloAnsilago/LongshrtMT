<script>
  (function () {
    const leftData = {{ left_series_json|safe }};
    const rightData = {{ right_series_json|safe }};
    const leftCandles = {{ left_candles_json|safe }};
    const rightCandles = {{ right_candles_json|safe }};
    const leftEntryPrice = {{ left_entry_price_json|safe }};
    const rightEntryPrice = {{ right_entry_price_json|safe }};
    const entryDate = {{ entry_date_json|safe }};
    const leftEl = document.getElementById('chartLeft');
    const rightEl = document.getElementById('chartRight');
    if (!leftEl || !rightEl || !window.LightweightCharts) {
      return;
    }

    const baseOptions = {
      layout: {
        background: { color: 'transparent' },
        textColor: '#6c757d'
      },
      grid: {
        vertLines: { color: 'rgba(0,0,0,0.06)' },
        horzLines: { color: 'rgba(0,0,0,0.06)' }
      },
      rightPriceScale: { borderColor: 'rgba(0,0,0,0.1)' },
      timeScale: { borderColor: 'rgba(0,0,0,0.1)' },
      crosshair: {
        vertLine: { color: 'rgba(0,0,0,0.25)' },
        horzLine: { color: 'rgba(0,0,0,0.25)' }
      }
    };

    const leftChart = LightweightCharts.createChart(leftEl, baseOptions);
    const leftSeries = leftChart.addLineSeries({ color: '#dc3545', lineWidth: 2 });
    const leftCandleSeries = leftChart.addCandlestickSeries({
      upColor: '#0d6efd',
      downColor: '#dc3545',
      borderDownColor: '#dc3545',
      borderUpColor: '#0d6efd',
      wickDownColor: '#dc3545',
      wickUpColor: '#0d6efd'
    });
    leftSeries.setData(leftData || []);
    leftCandleSeries.setData(leftCandles || []);
    leftCandleSeries.applyOptions({ visible: false });
    if (typeof leftEntryPrice === 'number') {
      leftSeries.createPriceLine({
        price: leftEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
      leftCandleSeries.createPriceLine({
        price: leftEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
    }
    leftChart.timeScale().fitContent();

    const rightChart = LightweightCharts.createChart(rightEl, baseOptions);
    const rightSeries = rightChart.addLineSeries({ color: '#198754', lineWidth: 2 });
    const rightCandleSeries = rightChart.addCandlestickSeries({
      upColor: '#0d6efd',
      downColor: '#dc3545',
      borderDownColor: '#dc3545',
      borderUpColor: '#0d6efd',
      wickDownColor: '#dc3545',
      wickUpColor: '#0d6efd'
    });
    rightSeries.setData(rightData || []);
    rightCandleSeries.setData(rightCandles || []);
    rightCandleSeries.applyOptions({ visible: false });
    if (typeof rightEntryPrice === 'number') {
      rightSeries.createPriceLine({
        price: rightEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
      rightCandleSeries.createPriceLine({
        price: rightEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
    }
    rightChart.timeScale().fitContent();

    const btnLine = document.getElementById('btnLine');
    const btnCandle = document.getElementById('btnCandle');
    const setMode = (mode) => {
      const isCandle = mode === 'candle';
      leftSeries.applyOptions({ visible: !isCandle });
      rightSeries.applyOptions({ visible: !isCandle });
      leftCandleSeries.applyOptions({ visible: isCandle });
      rightCandleSeries.applyOptions({ visible: isCandle });
      if (btnLine) btnLine.classList.toggle('active', !isCandle);
      if (btnCandle) btnCandle.classList.toggle('active', isCandle);
    };
    if (btnLine) btnLine.addEventListener('click', () => setMode('line'));
    if (btnCandle) btnCandle.addEventListener('click', () => setMode('candle'));
    setMode({% if candles_ready %}'candle'{% else %}'line'{% endif %});

    if (entryDate) {
      leftCandleSeries.setMarkers([{
        time: entryDate,
        position: 'aboveBar',
        color: '#000000',
        shape: 'arrowDown',
        text: 'Entrada'
      }]);
      rightCandleSeries.setMarkers([{
        time: entryDate,
        position: 'belowBar',
        color: '#000000',
        shape: 'arrowUp',
        text: 'Entrada'
      }]);
    }

    const resizeCharts = () => {
      leftChart.applyOptions({ width: leftEl.clientWidth, height: leftEl.clientHeight });
      rightChart.applyOptions({ width: rightEl.clientWidth, height: rightEl.clientHeight });
    };

    window.addEventListener('resize', resizeCharts);
    resizeCharts();
  })();
</script>
