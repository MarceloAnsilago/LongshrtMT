{% extends "_base.html" %}

{% block extra_head %}
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="card shadow-sm rounded-4 soft-card mb-3">
    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h1 class="h5 mb-1 fw-semibold">Graficos - {{ pair_label }}</h1>
        <div class="text-body-secondary small">Janela: {{ window }}d (linha)</div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <div class="btn-group btn-group-sm" role="group" aria-label="Tipo de grafico">
          <button type="button" class="btn btn-outline-primary" id="btnLine">Linha</button>
          <button type="button" class="btn btn-outline-primary" id="btnCandle" {% if not candles_ready %}disabled{% endif %}>
            Candle
          </button>
        </div>
        <a class="btn btn-outline-primary btn-sm" href="{% url 'pairs:analysis_prices' %}?{{ request.GET.urlencode }}&refresh=1">
          Atualizar
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'core:home' %}">
          Voltar para o inicio
        </a>
      </div>
    </div>
  </div>

  {% if mt5_error %}
    <div class="alert alert-warning small mb-3">
      Falha ao atualizar via MT5: {{ mt5_error }}
    </div>
  {% elif not candles_ready %}
    <div class="alert alert-info small mb-3">
      Candles indisponiveis: faltam dados OHLC para um dos ativos.
    </div>
  {% endif %}

  <div class="card shadow-sm rounded-4">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <div class="fw-semibold text-danger">Vendido - {{ left_label }}</div>
        {% if left_entry_label and left_entry_label != "--" %}
          <div class="text-body-secondary small">Entrada: {{ left_entry_label }}</div>
        {% endif %}
      </div>
      <div id="chartLeft" style="height:300px;"></div>
      <hr class="my-3 text-body-tertiary">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <div class="fw-semibold text-success">Comprado - {{ right_label }}</div>
        {% if right_entry_label and right_entry_label != "--" %}
          <div class="text-body-secondary small">Entrada: {{ right_entry_label }}</div>
        {% endif %}
      </div>
      <div id="chartRight" style="height:300px;"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const leftData = {{ left_series_json|safe }};
    const rightData = {{ right_series_json|safe }};
    const leftCandles = {{ left_candles_json|safe }};
    const rightCandles = {{ right_candles_json|safe }};
    const leftEntryPrice = {{ left_entry_price_json|safe }};
    const rightEntryPrice = {{ right_entry_price_json|safe }};
    const entryDate = {{ entry_date_json|safe }};
    const leftEl = document.getElementById('chartLeft');
    const rightEl = document.getElementById('chartRight');
    if (!leftEl || !rightEl || !window.LightweightCharts) {
      return;
    }

    const baseOptions = {
      layout: {
        background: { color: 'transparent' },
        textColor: '#6c757d'
      },
      grid: {
        vertLines: { color: 'rgba(0,0,0,0.06)' },
        horzLines: { color: 'rgba(0,0,0,0.06)' }
      },
      rightPriceScale: { borderColor: 'rgba(0,0,0,0.1)' },
      timeScale: { borderColor: 'rgba(0,0,0,0.1)' },
      crosshair: {
        vertLine: { color: 'rgba(0,0,0,0.25)' },
        horzLine: { color: 'rgba(0,0,0,0.25)' }
      }
    };

    const leftChart = LightweightCharts.createChart(leftEl, baseOptions);
    const leftSeries = leftChart.addLineSeries({ color: '#dc3545', lineWidth: 2 });
    const leftCandleSeries = leftChart.addCandlestickSeries({
      upColor: '#0d6efd',
      downColor: '#dc3545',
      borderDownColor: '#dc3545',
      borderUpColor: '#0d6efd',
      wickDownColor: '#dc3545',
      wickUpColor: '#0d6efd'
    });
    leftSeries.setData(leftData || []);
    leftCandleSeries.setData(leftCandles || []);
    leftCandleSeries.applyOptions({ visible: false });
    if (typeof leftEntryPrice === 'number') {
      leftSeries.createPriceLine({
        price: leftEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
      leftCandleSeries.createPriceLine({
        price: leftEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
    }
    leftChart.timeScale().fitContent();

    const rightChart = LightweightCharts.createChart(rightEl, baseOptions);
    const rightSeries = rightChart.addLineSeries({ color: '#198754', lineWidth: 2 });
    const rightCandleSeries = rightChart.addCandlestickSeries({
      upColor: '#0d6efd',
      downColor: '#dc3545',
      borderDownColor: '#dc3545',
      borderUpColor: '#0d6efd',
      wickDownColor: '#dc3545',
      wickUpColor: '#0d6efd'
    });
    rightSeries.setData(rightData || []);
    rightCandleSeries.setData(rightCandles || []);
    rightCandleSeries.applyOptions({ visible: false });
    if (typeof rightEntryPrice === 'number') {
      rightSeries.createPriceLine({
        price: rightEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
      rightCandleSeries.createPriceLine({
        price: rightEntryPrice,
        color: '#0d6efd',
        lineWidth: 1,
        lineStyle: 2,
        axisLabelVisible: false,
        title: ''
      });
    }
    rightChart.timeScale().fitContent();

    const btnLine = document.getElementById('btnLine');
    const btnCandle = document.getElementById('btnCandle');
    const setMode = (mode) => {
      const isCandle = mode === 'candle';
      leftSeries.applyOptions({ visible: !isCandle });
      rightSeries.applyOptions({ visible: !isCandle });
      leftCandleSeries.applyOptions({ visible: isCandle });
      rightCandleSeries.applyOptions({ visible: isCandle });
      if (btnLine) btnLine.classList.toggle('active', !isCandle);
      if (btnCandle) btnCandle.classList.toggle('active', isCandle);
    };
    if (btnLine) btnLine.addEventListener('click', () => setMode('line'));
    if (btnCandle) btnCandle.addEventListener('click', () => setMode('candle'));
    setMode({% if candles_ready %}'candle'{% else %}'line'{% endif %});

    if (entryDate) {
      leftCandleSeries.setMarkers([{
        time: entryDate,
        position: 'aboveBar',
        color: '#000000',
        shape: 'arrowDown',
        text: 'Entrada'
      }]);
      rightCandleSeries.setMarkers([{
        time: entryDate,
        position: 'belowBar',
        color: '#000000',
        shape: 'arrowUp',
        text: 'Entrada'
      }]);
    }

    const resizeCharts = () => {
      leftChart.applyOptions({ width: leftEl.clientWidth, height: leftEl.clientHeight });
      rightChart.applyOptions({ width: rightEl.clientWidth, height: rightEl.clientHeight });
    };

    window.addEventListener('resize', resizeCharts);
    resizeCharts();
  })();
</script>
{% endblock %}
